AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  ecs_cosign_verify
  
  Template for ecs_cosign_verify

Globals:
  Function:
    Timeout: 5
Parameters:
    KeyArn:
      Type: String
Resources:
  TeamNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      KmsMasterKeyId: !GetAtt TeamNotificationTopicKey.Arn
  TeamNotificationTopicKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Statement:
          - Action: kms:*
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Resource: '*'
      EnableKeyRotation: true
  ECSApprovedContainerRegistryFunction:
    Type: AWS::Serverless::Function 
    Properties:
      CodeUri: cosign-ecs-function/
      Handler: cosign-ecs-function
      Runtime: go1.x
      Timeout: 20
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref TeamNotificationTopic
          COSIGN_KEY: !Ref KeyArn
      Tracing: Active
      MemorySize: 512
      Policies:
      - AWSXrayWriteOnlyAccess
      - AWSLambdaBasicExecutionRole
      - SNSPublishMessagePolicy:
          TopicName: 
            !Ref TeamNotificationTopic
      - Statement:  # Stop unauthorized tasks
        - Sid: ECSTaskPolicy
          Effect: Allow
          Action:
          - ecs:StopTask
          Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:task/*' 
      - Statement:  # TODO: do we need this?
        - Sid: ECSServiceRWPolicy
          Effect: Allow
          Action:
          - ecs:UpdateService
          Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/*'
      - Statement:  # TODO: do we need this?
        - Sid: ECSServiceListPolicy
          Effect: Allow
          Action:
          - ecs:ListServices
          Resource: '*'
      - Statement:  # TODO: is this used?
        - Sid: ECSTaskDefinitionPolicy
          Effect: Allow
          Action:
          - ecs:DeregisterTaskDefinition
          Resource: '*'
      - Statement:  # KMS key for communication with SNS
        - Sid: KMSPolicy
          Effect: Allow
          Action:
          - kms:GenerateDataKey
          - kms:Decrypt
          Resource: !GetAtt TeamNotificationTopicKey.Arn
      - Statement:  # Is the other ECR policy sufficient?
          - Sid: ECRPolicy2
            Effect: Allow
            Action:
              - ecr:*
            Resource:
              - '*'
      - Statement:  # Get image information/signature from the repository to verify
        - Sid: ECRPolicy
          Effect: Allow
          Action:
            - ecr:GetAuthorizationToken
            - ecr:ListImages
            - ecr:Get*
            - ecr:Describe*
          Resource: !Sub 'arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*'
      - Statement:  # Notify about invalid signatures via SNS
          - Sid: SNSPublishPolicy
            Effect: Allow
            Action:
              - sns:Publish
            Resource: !Ref TeamNotificationTopic
      - Statement:  # Access the key with which to check signatures
          - Sid: COSIGNKMSPolicy
            Effect: Allow
            Action:
              - kms:GetPublicKey
              - kms:DescribeKey
            Resource: !Ref KeyArn
      Events:
        Trigger:
          Type: CloudWatchEvent 
          Properties:
            Pattern:
              source:
                - aws.ecs
              detail-type:
                - ECS Task State Change
                - ECS Container Instance State Change
              detail:
                desiredStatus:
                  - RUNNING
                  - PENDING
                  - ACTIVATING
                  - PROVISIONING
